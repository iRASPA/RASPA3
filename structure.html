<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>RASPA3: Appendix: Structure of the RASPA Code</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  extensions: ["tex2jax.js"],
  jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="https://cdn.jsdelivr.net/npm/mathjax@2/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="doxygen-awesome-sidebar-only.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">RASPA3<span id="projectnumber">&#160;3.0.13</span>
   </div>
   <div id="projectbrief">A molecular simulation code for computing adsorption and diffusion in nanoporous materials</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.8 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('structure.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Appendix: Structure of the RASPA Code</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>Main structure</h1>
<p>RASPA is organized in such a way that it is modular and configurable to run multiple systems. In general there is the subdivision of RASPA into the different "kits":</p><ul>
<li>raspakit: contains all the main code for running simulations and doing molecular mechanics.</li>
<li>foundationkit: contains many helper functions to do reading / writing.</li>
<li>mathkit: contains mathematical classes with predefined arithmatic behavior.</li>
<li>symmetrykit: contains helper functions for reading cif files.</li>
<li>utilitykit: contains factory class constructors for benchmarking and testing suite.</li>
</ul>
<p>In terms of running a simulation the most global description would be "an api creates and runs a simulation routine which operates on systems". The simulation starts on the user end with creating either a <code>simulation.json</code> input file for RASPA to read with its <code><a class="el" href="structInputReader.html" title="Class responsible for reading and parsing simulation input files.">InputReader</a></code> class, or scripting via python. For now, we will discuss just the <code><a class="el" href="structInputReader.html" title="Class responsible for reading and parsing simulation input files.">InputReader</a></code> API, which parses the json and from its contents constructs and links all necessary elements of the simulation.</p>
<p>It creates a simulation routine object, which can be for example <code><a class="el" href="structMonteCarlo.html" title="Performs Monte Carlo simulations for molecular systems.">MonteCarlo</a></code>. The created <code><a class="el" href="structMonteCarlo.html" title="Performs Monte Carlo simulations for molecular systems.">MonteCarlo</a></code> object holds a list of <code><a class="el" href="structSystem.html" title="Represents the central system for simulations.">System</a></code>s, in most cases just one, but when running Gibbs ensemble or parallel tempering simulations this can be many systems.</p>
<div class="image">
<img src="struct_main.png" alt=""/>
</div>
 <h1><a class="el" href="structSystem.html" title="Represents the central system for simulations.">System</a> structure</h1>
<p>The <code><a class="el" href="structSystem.html" title="Represents the central system for simulations.">System</a></code> object is the main simulation object in is a container for all objects holding molecular information, property writers, the force field, the simulation box, framework and many others. Except for owning objects, some parts of RASPA are not object based, but are functions, routines that can operate on a given (reference to) set of data provided by the system. When function calls don't need data persistence between call, using a function is better.</p>
<p>The reason the system is the "owner" of all these objects is because they can vary between different systems, for example when using different force fields or simulation settings. The <code><a class="el" href="structMonteCarlo.html" title="Performs Monte Carlo simulations for molecular systems.">MonteCarlo</a></code> object now starts the main simulation loop and operates on the system, by calling the various methods the system provides an interface to. For example, the <code><a class="el" href="structMonteCarlo.html" title="Performs Monte Carlo simulations for molecular systems.">MonteCarlo</a></code> object can call a Monte Carlo move on the system, which will then propose and possibly accept a new state, which then updates the system state by updating its information.</p>
<div class="image">
<img src="struct_system.png" alt=""/>
</div>
 <h1>MC Moves and MD Integrators</h1>
<p>The general structure of a call to an MC move or to an MD integrator is actually quite similar. The <code><a class="el" href="structSystem.html" title="Represents the central system for simulations.">System</a></code> gets a call from the simulation routine to perform either a Monte Carlo move or MD integration step.</p>
<p>For the Monte Carlo move, it will first call <code>performRandomMove</code>, which will, based on the given probabilities per move, pick a random move. This move proposes a new state and calls <code>Interactions</code> routines, which calculate the energy difference. The <code>Interactions</code> routine splits up the energy into the different summed parts (internal, framework-molecule, molecule-molecule, etc.) and those routines loop over the relevant subselections of atoms and call <code>Potentials</code>. <code>Potentials</code> are functions that calculate the actual energy based on a distance and a set of parameters, such as the Lennard-Jones energy. As soon as this calculation has finished, the Monte Carlo move now calculates the transition probability between states and then will randomly either accept or reject the new state with the right probability. If the state is accepted the <code>atomPositions</code> and / or <code>simulationBox</code> are updated and the energy difference is returned and added to the energy accounting object <code>runningEnergies</code>.</p>
<div class="image">
<img src="struct_mcmove.png" alt=""/>
</div>
 <p>Similarly the <code><a class="el" href="structSystem.html" title="Represents the central system for simulations.">System</a></code> can call an integrator, for example <code>velocityVerlet</code>, which will then use the Velocity Verlet algorithm to calculate the half-step differences in the velocities and positions. Importantly, the gradients are updated using a function <code>updateGradients</code>, which will similarly use <code>Interactions</code>, which call <code>Potentials</code> to now calculate the energy and gradient of the different potential energy functions. <code>velocityVerlet</code> updates the positions and momenta again and optionally calls the thermostat to update the momenta again.</p>
<div class="image">
<img src="struct_integrators.png" alt=""/>
</div>
 <h1>Example: CB/CFCMC Move</h1>
<p>One example of a Monte Carlo move - which may also be the most complex move RASPA offers, is the "Configurational Bias Continuous Fractional Component Monte Carlo" move (our naming is still better than the DFT people name their XC functionals). The CB/CFCMC move is a combination of the CBMC move and the CFCMC move. The CBMC move increases the acceptance probability - and therefore decorrelation of the simulation - by proposing multiple possible states and selecting the best from the Boltzmann weight of the state with some extra accounting to keep detailed balance. CFCMC increases the acceptance by making one particle a fractional particle ($0 &lt; \lambda &lt;= 1$), such that the energy barrier of insertion is lower and more gradual.</p>
<p>The CB/CFCMC move starts by randomly sampling a random displacement $\Delta \lambda$, which alters the particle size. If $\lambda + \Delta \lamda &lt; 1$ a deletion move is done (left branch in figure), else if $\lambda + \Delta \lamda \ge 1$ an insertion move is done, otherwise there will be just a scaling. If there is an insertion (deletion) taking place a new fractional particle should be placed (chosen), such that there is always 1 fractional particle. For this the CBMC routines are used. In all cases the new interaction energies are calculated and are then used to determine what the probability of acceptance of this move is. If this move is accepted, a set of routines is called (labeled Update in the figure) to alter the system state.</p>
<div class="image">
<img src="struct_cbcfcmc.png" alt=""/>
</div>
  </div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="md_docs_2manual.html">User Manual</a></li>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.8 </li>
  </ul>
</div>
</body>
</html>
